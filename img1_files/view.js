define(["plugin-dependencies","jquery","underscore","backbone","require","plugin-components/data-store","text!./view.html","text!./info.html"],function(e,t,i,s,n,a,o,l){var r=e.utils.template.createTemplate(o),d=e.utils.template.createTemplate(l),c={},u=["type","created","modified","size","width","height","shared"],h=e.log();return s.View.extend({className:"control-container",initialize:function(){i.bindAll(this,"getAsset","addShortUrl","handleShareButtonClick","updateShareButtonUi","updateCollaborationUi","parseInfo","handleReportAbuse","analyticsAcessPrivacy")},render:function(){var t=this;return this.$el.find(".made-with-container").show(),this.getAsset().then(function(s){t.$el.html(r({translate:e.translate})),e.user.isEnterprise()&&(u=i.without(u,i.findWhere(u,"shared")));var a=t.parseInfo();t.$el.find("ul").append(d({translate:e.translate,value:a})),t.$(".report-abuse-container button").click(t.handleReportAbuse),e.user.isEnterprise()?t.$el.find(".access").parent().remove():(t.$(".access button").click(t.handleShareButtonClick),t.model.set("shared",""),n(["files/dialogs/send-link/api"],function(e){e.validateAssetPermissions(s).then(function(){return e.getResourceLinks(s)}).then(function(e){e&&e.id?(t.linkId=e.id,t.model.set("shared",!0)):t.model.set("shared",!1),t.$el.find(".access button").css("visibility","visible"),t.analyticsAcessPrivacy()})}));var o=t.$el.find("#made-with"),l=t.model.get("colors"),c=t.model.get("app"),p=t.model.get("fonts");o.empty(),l&&n(["./media-info/colors"],function(e){o.append(e.setResource(l).render().$el),e.$el.on("click",function(){h("ets",{code:"CC_FILE_ACTIVITY",sub_code:"KULER"})})}),c&&n(["./media-info/app"],function(e){o.append(e.setResource(c).render().$el)}),p&&n(["./media-info/fonts"],function(e){o.append(e.setResource(p).render().$el)}),l||c||p||t.$el.find(".made-with-container").hide(),e.user.isEnterprise()||(t.updateShareButtonUi(),t.model.on("change:shared",t.updateShareButtonUi)),t.updateCollaborationUi(),t.model.on("change:_collaboratorCount",t.updateCollaborationUi)}),this},analyticsAcessPrivacy:function(){var e=t(".access button").text();h("cca",{root:{access:e,assetid:this.model.get("id")}})},getAsset:function(){var e=this,i=t.Deferred(),s=a.asset(this.model.get("id")).colors||a.asset(this.model.get("id")).app||a.asset(this.model.get("id")).fonts;return s?i.resolve(a.asset(this.model.get("id"))):a.refreshAsset(this.model.get("id"),function(t){c=t.updatedAttributes?t.updatedAttributes:e.model.toJSON(),i.resolve(c)}),i},setModel:function(e){this.model=e},addShortUrl:function(){var i=this.model.get("publicURL");if(i)t(".public-url").html(' <a href="'+i+'" target="_blank">'+i+"</a>");else{var s=this.linkId;e.utils.getShortPublicShareUrl(s).then(function(e){t(".public-url").html(' <a href="'+e+'" target="_blank">'+e+"</a>")})}},handleShareButtonClick:function(){h("cca",{code:"Send Link",root:{assetType:"File",assetid:this.model.get("id"),dropDown:"Access"}});var t=this;e.utils.hasFeature("files_new_send_link_dialog")?n(["files/dialogs/new-send-link/dialog"],function(e){e.setItem(t.model.toJSON()).show().on("link.created",function(e,i){e.stopPropagation(),t.linkId=i.id,t.model.set("shared",!0)}).on("link.deleted",function(e){e.stopPropagation(),t.linkId=!1,t.model.set("shared",!1)})}):n(["files/dialogs/send-link/dialog"],function(e){e.setItem(t.model.toJSON()).show().on("link.created",function(e,i){e.stopPropagation(),t.linkId=i.id,t.model.set("shared",!0)}).on("link.deleted",function(e){e.stopPropagation(),t.linkId=!1,t.model.set("shared",!1)})})},updateCollaborationUi:function(){var e=this.model.get("_collaboratorCount");0===e?this.$(".report-abuse-container").hide():this.$(".report-abuse-container").show()},updateShareButtonUi:function(){var t=this.$el.find(".access"),i=this.$el.find(".access button"),s=this.$el.find(".public-url"),n='<em class="sprite30x30"></em>';this.model.get("shared")?(t.removeClass("private").addClass("public"),i.html(n+e.translate("Public")),this.addShortUrl()):(t.removeClass("public").addClass("private"),i.html(n+e.translate("Private")),s.empty())},parseInfo:function(){for(var t={},s=0;s<u.length;s++){var n=u[s],a=this.model.get(n);if("type"===n&&(a=i.isUndefined(e.mimetypes.files[a])?i.last(a.split("/")):e.mimetypes.files[a]),("created"===n||"modified"===n)&&(a=e.utils.formatDate(new Date(a))),"size"===n&&(a=e.utils.translateBytes(a)),("width"===n||"height"===n)&&(a=e.translate("{0}px",a)),"shared"===n){var o=e.translate(a?"Public":"Private");a='<button type="button"><em class="sprite30x30"></em>'+o+'</button><span class="public-url"></span>'}t[n]=a}return t},handleReportAbuse:function(){var e=this.model;n(["files/dialogs/report-abuse/dialog"],function(t){t.setFile(e).show()})}})});