define(["plugin-dependencies","jquery","underscore","backbone","plugin-components/data-store","common/datastore/collabservice/api/comments/read"],function(e,t,n,r,s,i){var o=r.Collection.extend({initialize:function(){n.bindAll(this,"fetchActivityStream","collapseVersions"),this.on("add",function(e){"undefined"!=typeof e.get("revision_number")?e.set("type","version"):e.set("type","comment")})},comparator:function(e,t){return e.get("created")!==t.get("created")?e.get("created")>t.get("created")?-1:1:void 0},fetchActivityStream:function(e){this.reset();var n=this,r=[],o=[],c=t.Deferred(),a=this.assetModel.get("id"),d=function(){var n=t.Deferred(),r=s.asset(a).revisions;return r&&!e?n.resolve(s.asset(a).revisions):s.refreshAsset(a,function(e){e.updatedAttributes&&n.resolve(e.updatedAttributes.revisions)}),n},u=function(){var e=t.Deferred();return i(a).done(function(t){e.resolve(t)}),e};return d().then(function(e){r=e||[]}).then(u).then(function(e){o=e||[]}).always(function(){n.add(r.concat(o)),c.resolve(n.collapseVersions(n.models))}),c},collapseVersions:function(t){for(var n=[],r=[],s=300;t.length>0;){var i=t.shift(),o=t[0],c=i.get("isVersionHead");"version"!==i.get("type")||c?(n.length>0&&(r.push(n),n=[]),r.push(i)):o&&"version"===o.get("type")&&!o.get("isVersionHead")&&e.utils.convertDiffUtToSeconds(o.get("created"))-e.utils.convertDiffUtToSeconds(i.get("created"))<s?n.push(i):0===n.length?r.push(i):(n.push(i),r.push(n),n=[])}return r}});return o});